<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Control Panel</title>
</head>
<body onload="loadFiles()">

    <h1>TFTP Server Management</h1>
    
    <label for="file-select">Select operating system:</label>
    <select id="file-select">
        <option value="">Loading...</option>
    </select>
    <br><br>
    <div style="margin-top: 10px;">
        <label for="rename-input">Rename installation file:</label><br>
        <input type="text" id="rename-input" placeholder="e.g., pxelinux.0">
        <small>(Will be renamed to `install`)</small>
    </div>
    <br>
    <button id="run-button">Copy to TFTP Server Root</button>
    <hr>
    <div>
        <button id="clear-button" style="background-color: #ffcccc; color: #a00;">
            CLEAR TFTP Server Root
        </button>
    </div>
    <hr style="margin-top: 20px;">
    <h2>Download OS (.zip/.tar.gz)</h2>
    
    <div>
        <label for="download-url">Archive URL:</label><br>
        <input type="text" id="download-url" style="width: 400px;" placeholder="https://example.com/archive.zip">
    </div>
    <div style="margin-top: 10px;">
        <label for="new-dir-name">Operating system name:</label><br>
        <input type="text" id="new-dir-name" placeholder="e.g., NewProject">
    </div>
    <br>
    <button id="download-button" style="background-color: #cceeff;">
        Download and Extract
    </button>
    <h3>Status:</h3>
    <pre id="response-output"></pre>


    <script>
        const selectMenu = document.getElementById('file-select');
        const checkboxDetailed = document.getElementById('detailed-mode');
        const inputRename = document.getElementById('rename-input');
        const buttonRun = document.getElementById('run-button');
        const buttonClear = document.getElementById('clear-button');
        const output = document.getElementById('response-output');
        const inputUrl = document.getElementById('download-url');
        const inputDirName = document.getElementById('new-dir-name');
        const buttonDownload = document.getElementById('download-button');

       // =========================================================
        // LOAD FILES FUNCTION (now '/api/get-dirs')
        // =========================================================
        async function loadFiles() {
            output.textContent = 'Loading directory list...';
            try {
                const response = await fetch('/api/get-dirs'); 
                
                if (!response.ok) {
                    const errorData = await response.json(); 
                    output.textContent = `❌ Server error (${response.status}): ${errorData.message || 'Unknown error'}`;
                    return;
                }
                const data = await response.json();
                
                if (data.success && data.files.length > 0) {
                    selectMenu.innerHTML = ''; 
                    data.files.forEach(dirName => {
                        const option = document.createElement('option');
                        option.value = dirName;
                        option.textContent = dirName;
                        selectMenu.appendChild(option);
                    });
                    output.textContent = `Loaded ${data.files.length} operating systems.`;
                } else if (data.success && data.files.length === 0) {
                    selectMenu.innerHTML = '<option value="">Library is empty</option>';
                    output.textContent = 'Operating system library is empty.';
                } else {
                    output.textContent = `Load error: ${data.message}`;
                }
            } catch (error) {
                output.textContent = 'Error connecting to API server.';
            }
        }

        // =========================================================
        // COPY BUTTON HANDLER
        // =========================================================
        buttonRun.addEventListener('click', async () => {
            const selectedDir = selectMenu.value;
            const fileToRename = inputRename.value;
            
            if (!selectedDir) {
                output.textContent = '⚠️ Please select an operating system to copy.';
                return;
            }

            const options = {
                detailed: checkboxDetailed.checked
            };

            output.textContent = `Processing "${selectedDir}"...`;

            try {
                const response = await fetch('/api/process-directory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dirname: selectedDir,   // Directory name
                        renameFile: fileToRename, // File name to rename
                        options: options
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    output.textContent = result.message;
                    loadFiles(); // Reload the list
                } else {
                    output.textContent = `❌ Processing error: ${result.message}`;
                }

            } catch (error) {
                output.textContent = 'Critical error while sending request.';
            }
        });

        // =========================================================
        // CLEAR BUTTON HANDLER
        // =========================================================
        buttonClear.addEventListener('click', async () => {
            
            if (!confirm('Are you sure you want to CLEAR the TFTP server root?')) {
                output.textContent = 'Clear operation canceled.';
                return;
            }

            output.textContent = 'Clearing...';

            try {
                // Send request to API route
                const response = await fetch('/api/clear-directory', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    output.textContent = result.message;
                } else {
                    output.textContent = `❌ Clear error: ${result.message}`;
                }

            } catch (error) {
                output.textContent = 'Critical error while sending clear request.';
            }
        });
		// =========================================================
        // DOWNLOAD BUTTON HANDLER
        // =========================================================
        buttonDownload.addEventListener('click', async () => {
            
            const url = inputUrl.value;
            const dirName = inputDirName.value;

            if (!url || !dirName) {
                output.textContent = '⚠️ URL and OS name are required.';
                return;
            }

            output.textContent = `Sending download request for "${url}"...`;

            try {
                const response = await fetch('/api/download-and-unpack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        dirName: dirName
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    output.textContent = result.message;
                    // UPDATE DIRECTORY LIST!
                    loadFiles(); 
                    // Clear input fields
                    inputUrl.value = '';
                    inputDirName.value = '';
                } else {
                    output.textContent = `❌ Error: ${result.message}`;
                }

            } catch (error) {
                output.textContent = 'Critical error while sending download request.';
            }
        });		
    </script>

</body>
</html>