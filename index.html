<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель управления</title>
</head>
<body onload="loadFiles()">

    <h1>Управление директориями</h1>
    
    <label for="file-select">Выберите директорию для обработки:</label>
    <select id="file-select">
        <option value="">Загрузка директорий...</option>
    </select>
    <br><br>
    <div>
        <input type="checkbox" id="detailed-mode">
        <label for="detailed-mode">Режим детального логгирования (Демо)</label>
    </div>
    <div style="margin-top: 10px;">
        <label for="rename-input">Переименовать файл внутри директории:</label><br>
        <input type="text" id="rename-input" placeholder="например, original.txt">
        <small>(Будет переименован в `install`)</small>
    </div>
    <br>
    <button id="run-button">Выполнить копирование директории</button>
    <hr>
    <div>
        <button id="clear-button" style="background-color: #ffcccc; color: #a00;">
            ОЧИСТИТЬ родительскую директорию назначения
        </button>
    </div>
    <hr style="margin-top: 20px;">
    <h2>Скачать и распаковать архив (.zip)</h2>
    
    <div>
        <label for="download-url">URL архива (.zip):</label><br>
        <input type="text" id="download-url" style="width: 400px;" placeholder="https://example.com/archive.zip">
    </div>
    <div style="margin-top: 10px;">
        <label for="new-dir-name">Имя для новой директории (в `sys_img`):</label><br>
        <input type="text" id="new-dir-name" placeholder="например, NewProject">
    </div>
    <br>
    <button id="download-button" style="background-color: #cceeff;">
        Скачать и распаковать
    </button>
    <h3>Статус:</h3>
    <pre id="response-output"></pre>


    <script>
        // Элементы управления копированием
        const selectMenu = document.getElementById('file-select');
        const checkboxDetailed = document.getElementById('detailed-mode');
        const inputRename = document.getElementById('rename-input');
        const buttonRun = document.getElementById('run-button');
        const buttonClear = document.getElementById('clear-button');
        const output = document.getElementById('response-output');

        // НОВЫЕ ЭЛЕМЕНТЫ ДЛЯ СКАЧИВАНИЯ
        const inputUrl = document.getElementById('download-url');
        const inputDirName = document.getElementById('new-dir-name');
        const buttonDownload = document.getElementById('download-button');

       // =========================================================
        // ФУНКЦИЯ ЗАГРУЗКИ (теперь '/api/get-dirs')
        // =========================================================
        async function loadFiles() {
            output.textContent = 'Загрузка списка директорий...';
            try {
                // ИЗМЕНЕНО: Запрашиваем новый API
                const response = await fetch('/api/get-dirs'); 
                
                if (!response.ok) {
                    const errorData = await response.json(); 
                    output.textContent = `❌ Ошибка сервера (${response.status}): ${errorData.message || 'Неизвестная ошибка'}`;
                    return;
                }
                const data = await response.json();
                
                if (data.success && data.files.length > 0) {
                    selectMenu.innerHTML = ''; 
                    data.files.forEach(dirName => { // 'files' - это теперь массив имен директорий
                        const option = document.createElement('option');
                        option.value = dirName;
                        option.textContent = dirName;
                        selectMenu.appendChild(option);
                    });
                    output.textContent = `Загружено ${data.files.length} директорий.`;
                } else if (data.success && data.files.length === 0) {
                    selectMenu.innerHTML = '<option value="">Нет директорий для обработки</option>';
                    output.textContent = 'Исходная директория пуста.';
                } else {
                    output.textContent = `Ошибка при загрузке: ${data.message}`;
                }
            } catch (error) {
                output.textContent = 'Ошибка подключения к серверу API.';
            }
        }

        // =========================================================
        // ОБРАБОТЧИК КНОПKI КОПИРОВАНИЯ (ОБНОВЛЕН)
        // =========================================================
        buttonRun.addEventListener('click', async () => {
            const selectedDir = selectMenu.value;
            const fileToRename = inputRename.value; // Получаем значение из поля ввода
            
            if (!selectedDir) {
                output.textContent = '⚠️ Пожалуйста, выберите директорию для копирования.';
                return;
            }

            const options = {
                detailed: checkboxDetailed.checked
                // noRename больше нет
            };

            output.textContent = `Обработка директории "${selectedDir}"...`;

            try {
                // ИЗМЕНЕНО: Вызываем новый API
                const response = await fetch('/api/process-directory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dirname: selectedDir,   // Имя директории
                        renameFile: fileToRename, // Имя файла для переименования
                        options: options
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    output.textContent = result.message;
                    loadFiles(); // Перезагружаем список
                } else {
                    output.textContent = `❌ Ошибка обработки: ${result.message}`;
                }

            } catch (error) {
                output.textContent = 'Критическая ошибка при отправке запроса.';
            }
        });

        // =========================================================
        // НОВЫЙ ОБРАБОТЧИК ДЛЯ КНОПКИ ОЧИСТКИ
        // =========================================================
        buttonClear.addEventListener('click', async () => {
            
            // ⚠️ Обязательное подтверждение
            if (!confirm('Вы уверены, что хотите ПОЛНОСТЬЮ ОЧИСТИТЬ директорию назначения? Эту операцию нельзя отменить.')) {
                output.textContent = 'Операция очистки отменена.';
                return;
            }

            output.textContent = 'Очистка директории...';

            try {
                // Отправляем запрос на новый API-маршрут
                const response = await fetch('/api/clear-directory', {
                    method: 'POST' // Тело не нужно, сам факт запроса - это команда
                });

                const result = await response.json();
                
                if (response.ok) {
                    output.textContent = result.message;
                } else {
                    output.textContent = `❌ Ошибка очистки: ${result.message}`;
                }

            } catch (error) {
                output.textContent = 'Критическая ошибка при отправке запроса на очистку.';
            }
        });
		// =========================================================
        // НОВЫЙ ОБРАБОТЧИК ДЛЯ КНОПКИ СКАЧИВАНИЯ
        // =========================================================
        buttonDownload.addEventListener('click', async () => {
            
            const url = inputUrl.value;
            const dirName = inputDirName.value;

            if (!url || !dirName) {
                output.textContent = '⚠️ URL и Имя новой директории обязательны.';
                return;
            }

            output.textContent = `Отправка запроса на скачивание "${url}"...`;

            try {
                const response = await fetch('/api/download-and-unpack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        dirName: dirName
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    output.textContent = result.message;
                    // ОБНОВЛЯЕМ СПИСОК ДИРЕКТОРИЙ!
                    loadFiles(); 
                    // Очищаем поля ввода
                    inputUrl.value = '';
                    inputDirName.value = '';
                } else {
                    output.textContent = `❌ Ошибка: ${result.message}`;
                }

            } catch (error) {
                output.textContent = 'Критическая ошибка при отправке запроса на скачивание.';
            }
        });		
    </script>

</body>
</html>